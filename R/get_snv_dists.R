#' Get matrix of inter- and intra-facility pariwise snv distances
#'
#' @param dists a SNV distance matrix returned by the dist.dna function from the ape package
#' @param locs a named vector of locations of isolates (e.g. facility of isolation), with the name being the sample ID
#' @param pt_trans_net a data.frame representing a patient transfer network of 3 cols: 'source_facil', 'dest_facil, and 'n_transfers'
#'
#' @return a data.frame of isolate pairs, their SNV distance, and labeled as either inter- or intra-facility pairs. If pt_trans_net provided will return both direct transfer and indirect flow metric for each facility pair.
#' @export
#'
#' @examples
#' \dontrun{
#' locs <- metadata %>% dplyr::select(isolate_id, facility) %>% tibble::deframe()
#' get_snv_dists(dists, locs)
#' }
get_snv_dists <- function(dists, locs, pt_trans_net = NULL){
  #checks
  check_get_snv_dists_input(dists, locs, pt_trans_net)

  #make the subsetted isolates object if there is no pt
  isolates <- intersect(names(locs), rownames(dists))

  #subset by locs
  #list ones in common before subsetting
  loc_sub <- locs[isolates]

  #subset dists to isolates
  dists_sub <- dists[isolates, isolates]

  #make df
  snps <- stats::na.omit(data.frame(as.table(as.matrix(dists_sub))))
  #change freq colname?
  colnames(snps) <- c("Isolate1", "Isolate2", "Pairwise_Dists")

  #add locs
  snps$Loc1 <- loc_sub[snps$Isolate1]
  snps$Loc2 <- loc_sub[snps$Isolate2]

  snp_facility_pairs <- dplyr::bind_cols(
    snps %>% dplyr::filter(Isolate1 != Isolate2) %>%
      dplyr::mutate(Pair_Type=ifelse(Loc1==Loc2,'Intra-facility pair','Inter-facility pair')))

  #if there is a patient transfer network, add it
  if(!is.null(pt_trans_net)){
    #calculate pt_transfer summaries
    pt_flow <- get_patient_transfers(pt_trans_net = pt_trans_net, snv_dists = snp_facility_pairs, paths = FALSE)
    snp_facility_pairs <- snp_facility_pairs %>%
      #add in patient transfers from 1 to 2
      dplyr::left_join(pt_flow, by = c("Loc1" = "Loc1", "Loc2" = "Loc2")) %>% dplyr::select(-n_closely_related_pairs)
  }

  # subset to include only one of each pair
  snp_facility_pairs <- subset_pairs(snp_facility_pairs)

  #return snp matrix
  return(snp_facility_pairs)
}


#' Subset to unique isolate pairs from a directed list
#'
#' @param snv_dists the output object of the get_snv_dists function
#'
#' @return a data.frame of isolate pairs subsetted to one row representing each pair
#' @noRd
#'
#' @examples
#' \dontrun{
#' locs <- metadata %>% dplyr::select(isolate_id, facility) %>% tibble::deframe()
#' snv_dists <- get_snv_dists(dists, locs)
#' subset_pairs(snv_dists)
#' }
subset_pairs <- function(snv_dists){
  #check that it is a data.frame object
  check_subset_pairs_input(snv_dists)
  #subset to one of each pair
  unique_rows <- snv_dists[!duplicated(t(apply(snv_dists, 1, sort))),]
  #return new df
  return(unique_rows)
}
