loc_n <- locs %>% table() %>% as.data.frame() %>% `colnames<-`(c("facilities", "n"))
facil_geo %>% left_join(loc_n) %>% ggplot(aes(x=latitudes, y=longitudes), color = "grey99") +
geom_point(aes(size=n), alpha=0.5) +
borders(database="world", regions = 'USA') +
coord_quickmap() +
geom_rect(aes(xmin = 75, xmax = 125, ymin = 30, ymax = 50), fill = "transparent", color = "darkgrey", size = 0.5) +
theme_void() + theme(legend.position = "none")
loc_n <- locs %>% table() %>% as.data.frame() %>% `colnames<-`(c("facilities", "n"))
facil_geo %>% left_join(loc_n) %>% ggplot(aes(x=latitudes, y=longitudes), color = "grey99") +
geom_point(aes(size=n), alpha=0.5) +
borders(database="world", regions = 'USA') +
coord_quickmap() +
theme_void() + theme(legend.position = "none")
loc_n <- locs %>% table() %>% as.data.frame() %>% `colnames<-`(c("facilities", "n"))
facil_geo %>% left_join(loc_n) %>% ggplot(aes(x=latitudes, y=longitudes), color = "grey99") +
geom_point(aes(size=n), alpha=0.5) +
#borders(database="world", regions = 'USA') +
coord_quickmap() +
theme_void() + theme(legend.position = "none")
loc_n <- locs %>% table() %>% as.data.frame() %>% `colnames<-`(c("facilities", "n"))
facil_geo %>% left_join(loc_n) %>% ggplot(aes(x=latitudes, y=longitudes), color = "grey99") +
geom_point(aes(size=n), alpha=0.5) +
borders(database="world", regions = 'USA') +
coord_quickmap() +
theme_void() + theme(legend.position = "none")
data(us.cities)
force(us.cities)
cities <- data(us.cities)
cities
data(us.cities)
force(us.cities)
cities <- force(us.cities)
cities
cities_sub <- cities[1:length(facilities),4:5]
cities_sub
facil_geo <- as.data.frame(cbind(facilities, cities_sub))
facil_geo
cities <- force(us.cities)
facilities <- unique(locs)
cities_sub <- cities[1:length(facilities),4:5]
facil_geo <- as.data.frame(cbind(facilities, cities_sub))
head(facil_geo)
facilities <- unique(locs)
facilities
cities <- force(us.cities)
facilities <- unique(locs)
cities_sub <- cities[1:length(facilities),4:5]
facil_geo <- as.data.frame(cbind(facilities, cities_sub))
head(facil_geo)
loc_n <- locs %>% table() %>% as.data.frame() %>% `colnames<-`(c("facilities", "n"))
facil_geo %>% left_join(loc_n) %>% ggplot(aes(x=latitudes, y=longitudes), color = "grey99") +
geom_point(aes(size=n), alpha=0.5) +
borders(database="world", regions = 'USA') +
coord_quickmap() +
theme_void() + theme(legend.position = "none")
loc_n <- locs %>% table() %>% as.data.frame() %>% `colnames<-`(c("facilities", "n"))
facil_geo %>% left_join(loc_n) %>% ggplot(aes(x=latitudes, y=longitudes), color = "grey99") +
geom_point(aes(size=n), alpha=0.5) +
borders("state") +
coord_quickmap() +
theme_void() + theme(legend.position = "none")
loc_n <- locs %>% table() %>% as.data.frame() %>% `colnames<-`(c("facilities", "n"))
facil_geo %>% left_join(loc_n) %>% ggplot(aes(x=latitudes, y=longitudes), color = "grey99") +
geom_point(aes(size=n), alpha=0.5) +
borders("state") + scale_size_area() +
coord_quickmap() +
theme_void() + theme(legend.position = "none")
loc_n <- locs %>% table() %>% as.data.frame() %>% `colnames<-`(c("facilities", "n"))
facil_geo %>% left_join(loc_n) %>% ggplot(aes(x=long, y=lat), color = "grey99") +
geom_point(aes(size=n), alpha=0.5) +
borders("state")
coord_quickmap() +
theme_void() + theme(legend.position = "none")
loc_n <- locs %>% table() %>% as.data.frame() %>% `colnames<-`(c("facilities", "n"))
facil_geo %>% left_join(loc_n) %>% ggplot(aes(x=long, y=lat), color = "grey99") +
geom_point(aes(size=n), alpha=0.5) +
borders("state") +
coord_quickmap() +
theme_void() + theme(legend.position = "none")
cities_sub
cities_sub <- cities[1:length(facilities),]
cities_sub
cities
cities <- force(us.cities) %>% filter(!country.etc %in% c("HI", "AK"))
facilities <- unique(locs)
cities_sub <- cities[1:length(facilities),4:5]
facil_geo <- as.data.frame(cbind(facilities, cities_sub))
head(facil_geo)
loc_n <- locs %>% table() %>% as.data.frame() %>% `colnames<-`(c("facilities", "n"))
facil_geo %>% left_join(loc_n) %>% ggplot(aes(x=long, y=lat), color = "grey99") +
geom_point(aes(size=n), alpha=0.5) +
borders("state") +
coord_quickmap() +
theme_void() + theme(legend.position = "none")
loc_n
Fsp
Fsp_long
loc_n %>% inner_join(Fsp_long, by = c("facilities" = "facil_1"))
facil_geo %>% left_join(loc_n) %>% inner_join(Fsp_long, by = c("facilities" = "facil_1"))
facil_geo %>% left_join(loc_n) %>% inner_join(Fsp_long, by = c("facil_1" = "facilities"))
facil_geo %>% left_join(loc_n) %>% inner_join(Fsp_long, by = c("facilities" = "facil_1")) %>% rename(facilities = facil_1)
facil_geo %>% left_join(loc_n) %>% inner_join(Fsp_long, by = c("facilities" = "facil_1")) %>% rename(facilities = "facil_1")
facil_geo %>% left_join(loc_n) %>% inner_join(Fsp_long, by = c("facilities" = "facil_1")) %>% rename(facilities = "facil_1")
facil_geo %>% left_join(loc_n)
Fsp_long
facil_geo %>% left_join(loc_n) %>% inner_join(Fsp_long, by = c("facilities" = "facil_1"))
facil_geo %>% left_join(loc_n) %>% inner_join(Fsp_long, by = c("facilities" = "facil_1")) %>% rename("facilities" = "facil_1")
facil_geo %>% left_join(loc_n) %>% inner_join(Fsp_long, by = c("facilities" = "facil_1")) %>% rename(facilities = facil_1)
facil_geo %>% left_join(loc_n) %>% inner_join(Fsp_long, by = c("facilities" = "facil_1")) %>% rename(facil_1 = facilities)
facil_geo %>% left_join(loc_n) %>% inner_join(Fsp_long, by = c("facilities" = "facil_1")) %>% rename(facil_1 = facilities)
facil_geo %>% left_join(loc_n) %>% inner_join(Fsp_long, by = c("facilities" = "facil_1")) %>% rename(facil_1 = facilities, facil_1_lat = lat, facil_1_long = long, facil_1_n = n) %>% inner_join(Fsp_long, by = c("facilities" = "facil_2")) %>% rename(facil_2 = facilities, facil_2_lat = lat, facil_2_long = long, facil_2_n = n)
facil_geo %>% left_join(loc_n) %>% inner_join(Fsp_long, by = c("facilities" = "facil_1")) %>% rename(facil_1 = facilities, facil_1_lat = lat, facil_1_long = long, facil_1_n = n)
facil_geo %>% left_join(loc_n) %>% inner_join(Fsp_long, by = c("facilities" = "facil_1")) %>% rename(facil_1 = facilities, facil_1_lat = lat, facil_1_long = long, facil_1_n = n) %>% inner_join(Fsp_long, by = c("facilities" = "facil_2"))
Fsp_long
facil_geo %>% left_join(loc_n) %>% inner_join(Fsp_long, by = c("facilities" = "facil_1")) %>% rename(facil_1 = facilities, facil_1_lat = lat, facil_1_long = long, facil_1_n = n)
Fsp_long
facil_geo %>% left_join(loc_n) %>% inner_join(Fsp_long, by = c("facilities" = "facil_1")) %>% rename(facil_1 = facilities, facil_1_lat = lat, facil_1_long = long, facil_1_n = n) %>% inner_join(Fsp_long, by = c("facil_2" = "facil_2")) %>% rename(facil_2 = facilities, facil_2_lat = lat, facil_2_long = long, facil_2_n = n)
facil_geo %>% left_join(loc_n) %>% inner_join(Fsp_long, by = c("facilities" = "facil_1")) %>% rename(facil_1 = facilities, facil_1_lat = lat, facil_1_long = long, facil_1_n = n) %>% inner_join(Fsp_long, by = c("facil_2" = "facil_2"))
Fsp_long %>% left_join(facil_geo, by = c("facilities" = "facil_1")) %>% rename(facil_1 = facilities, facil_1_lat = lat, facil_1_long = long, facil_1_n = n)
facil_geo <- facil_geo %>% left_join(loc_n)
Fsp_long %>% left_join(facil_geo, by = c("facilities" = "facil_1")) %>% rename(facil_1 = facilities, facil_1_lat = lat, facil_1_long = long, facil_1_n = n)
facil_geo
facil_geo <- as.data.frame(cbind(facilities, cities_sub))
head(facil_geo)
loc_n <- locs %>% table() %>% as.data.frame() %>% `colnames<-`(c("facilities", "n"))
facil_geo <- facil_geo %>% left_join(loc_n)
facil_geo
Fsp_long
Fsp_long %>% left_join(facil_geo, by = c("facil_1" = "facilities"))
Fsp_long %>% left_join(facil_geo, by = c("facil_1" = "facilities")) %>% rename(facil_1 = facilities, facil_1_lat = lat, facil_1_long = long, facil_1_n = n)
Fsp_long %>% left_join(facil_geo, by = c("facil_1" = "facilities"))
Fsp_long %>% left_join(facil_geo, by = c("facil_1" = "facilities")) %>% rename(facil_1_lat = lat, facil_1_long = long, facil_1_n = n)
Fsp_long %>% left_join(facil_geo, by = c("facil_1" = "facilities")) %>% rename(facil_1_lat = lat, facil_1_long = long, facil_1_n = n) %>% left_join(facil_geo, by = c("facil_2" = "facilities"))
Fsp_long %>% left_join(facil_geo, by = c("facil_1" = "facilities")) %>% rename(facil_1_lat = lat, facil_1_long = long, facil_1_n = n) %>% left_join(facil_geo, by = c("facil_2" = "facilities")) %>% rename(facil_2_lat = lat, facil_2_long = long, facil_2_n = n)
Fsp_geo <- Fsp_long %>% left_join(facil_geo, by = c("facil_1" = "facilities")) %>% rename(facil_1_lat = lat, facil_1_long = long, facil_1_n = n) %>% left_join(facil_geo, by = c("facil_2" = "facilities")) %>% rename(facil_2_lat = lat, facil_2_long = long, facil_2_n = n)
Fsp_geo
facil_geo
facil_geo %>% ggplot(aes(x=long, y=lat), color = "grey99") +
geom_point(aes(size=n), alpha=0.5) +
borders("state") +
coord_quickmap() +
geom_curve(aes(x = facil_1_long, y = facil_1_lat, xend = facil_2_long, yend = facil_2_lat,     # draw edges as arcs
size = n/max(n)),
data = Fsp_geo, curvature = 0.33,
alpha = 0.2) +
theme_void() + theme(legend.position = "none")
Fsp_geo
facil_geo %>% ggplot(aes(x=long, y=lat), color = "grey99") +
geom_point(aes(size=n), alpha=0.5) +
borders("state") +
coord_quickmap() +
geom_curve(aes(x = facil_1_long, y = facil_1_lat, xend = facil_2_long, yend = facil_2_lat,     # draw edges as arcs
size = Fsp_val),
data = Fsp_geo, curvature = 0.33,
alpha = 0.2) +
theme_void() + theme(legend.position = "none")
facil_geo %>% ggplot(aes(x=long, y=lat), color = "blue") +
geom_point(aes(size=n), alpha=0.5) +
borders("state") +
coord_quickmap() +
geom_curve(aes(x = facil_1_long, y = facil_1_lat, xend = facil_2_long, yend = facil_2_lat,     # draw edges as arcs
size = Fsp_val),
data = Fsp_geo, curvature = 0.33,
alpha = 0.2) +
theme_void() + theme(legend.position = "none")
facil_geo %>% ggplot(aes(x=long, y=lat)) +
geom_point(aes(size=n), alpha=0.5) +
borders("state") +
coord_quickmap() +
geom_curve(aes(x = facil_1_long, y = facil_1_lat, xend = facil_2_long, yend = facil_2_lat,     # draw edges as arcs
size = Fsp_val),
data = Fsp_geo, curvature = 0.33,
alpha = 0.2) +
theme_void() + theme(legend.position = "none")
facil_geo %>% ggplot(aes(x=long, y=lat), color = "blue") +
geom_point(aes(size=n), alpha=0.5) +
borders("state") +
coord_quickmap() +
geom_curve(aes(x = facil_1_long, y = facil_1_lat, xend = facil_2_long, yend = facil_2_lat,     # draw edges as arcs
size = Fsp_val),
data = Fsp_geo, curvature = 0.33,
alpha = 0.2) +
theme_void() + theme(legend.position = "none")
cities <- force(us.cities) %>% filter(!country.etc %in% c("HI", "AK"))
facilities <- unique(locs)
cities_sub <- cities[1:length(facilities),4:5]
facil_coord <- as.data.frame(cbind(facilities, cities_sub))
head(facil_geo)
loc_n <- locs %>% table() %>% as.data.frame() %>% `colnames<-`(c("facilities", "n"))
facil_geo <- facil_coord %>% left_join(loc_n)
Fsp_geo <- Fsp_long %>% left_join(facil_geo, by = c("facil_1" = "facilities")) %>% rename(facil_1_lat = lat, facil_1_long = long, facil_1_n = n) %>% left_join(facil_geo, by = c("facil_2" = "facilities")) %>% rename(facil_2_lat = lat, facil_2_long = long, facil_2_n = n)
facil_geo %>% ggplot(aes(x=long, y=lat)) +
geom_point(aes(size=n), alpha=0.5) +
borders("state") +
coord_quickmap() +
geom_curve(aes(x = facil_1_long, y = facil_1_lat, xend = facil_2_long, yend = facil_2_lat,     # draw edges as arcs
size = Fsp_val),
data = Fsp_geo, curvature = 0.33,
alpha = 0.2) +
theme_void() + theme(legend.position = "none")
pt_trans
facil_geo
pt_trans
loc_n <- locs %>% table() %>% as.data.frame() %>% `colnames<-`(c("facilities", "n"))
facil_geo <- facil_coord %>% left_join(loc_n)
trans_geo <- pt_trans %>% left_join(facil_geo, by = c("facil_1" = "facilities")) %>% rename(facil_1_lat = lat, facil_1_long = long, facil_1_n = n) %>% left_join(facil_geo, by = c("facil_2" = "facilities")) %>% rename(facil_2_lat = lat, facil_2_long = long, facil_2_n = n)
facil_geo %>% ggplot(aes(x=long, y=lat)) +
geom_point(aes(size=n), alpha=0.5) +
borders("state") +
coord_quickmap() +
geom_curve(aes(x = facil_1_long, y = facil_1_lat, xend = facil_2_long, yend = facil_2_lat,     # draw edges as arcs
size = n_transfers),
data = trans_geo, curvature = 0.33,
alpha = 0.2) +
theme_void() + theme(legend.position = "none")
loc_n <- locs %>% table() %>% as.data.frame() %>% `colnames<-`(c("facilities", "n"))
facil_geo <- facil_coord %>% left_join(loc_n)
trans_geo <- pt_trans %>% left_join(facil_geo, by = c("facil_1" = "facilities")) %>% rename(facil_1_lat = lat, facil_1_long = long, facil_1_n = n) %>% left_join(facil_geo, by = c("facil_2" = "facilities")) %>% rename(facil_2_lat = lat, facil_2_long = long, facil_2_n = n)
facil_geo %>% ggplot(aes(x=long, y=lat)) +
geom_point(aes(size=n), alpha=0.5) +
borders("state") +
coord_quickmap() +
geom_curve(aes(x = facil_1_long, y = facil_1_lat, xend = facil_2_long, yend = facil_2_lat,     # draw edges as arcs
size = n_transfers/max(n)),
data = trans_geo, curvature = 0.33,
alpha = 0.2) +
theme_void() + theme(legend.position = "none")
loc_n <- locs %>% table() %>% as.data.frame() %>% `colnames<-`(c("facilities", "n"))
facil_geo <- facil_coord %>% left_join(loc_n)
trans_geo <- pt_trans %>% left_join(facil_geo, by = c("facil_1" = "facilities")) %>% rename(facil_1_lat = lat, facil_1_long = long, facil_1_n = n) %>% left_join(facil_geo, by = c("facil_2" = "facilities")) %>% rename(facil_2_lat = lat, facil_2_long = long, facil_2_n = n)
facil_geo %>% ggplot(aes(x=long, y=lat)) +
geom_point(aes(size=n), alpha=0.5) +
borders("state") +
coord_quickmap() +
geom_curve(aes(x = facil_1_long, y = facil_1_lat, xend = facil_2_long, yend = facil_2_lat,     # draw edges as arcs
size = n_transfers/max(n_transfers)),
data = trans_geo, curvature = 0.33,
alpha = 0.2) +
theme_void() + theme(legend.position = "none")
facil_geo %>% ggplot(aes(x=long, y=lat)) +
geom_point(aes(size=n), alpha=0.5, color = "blue") +
borders("state") +
coord_quickmap() +
geom_curve(aes(x = facil_1_long, y = facil_1_lat, xend = facil_2_long, yend = facil_2_lat,     # draw edges as arcs
size = n_transfers/max(n_transfers)),
data = trans_geo, curvature = 0.33,
alpha = 0.2) +
theme_void() + theme(legend.position = "none")
i
facil_geo %>% ggplot(aes(x=long, y=lat)) +
borders("state") +
coord_quickmap() +
geom_curve(aes(x = facil_1_long, y = facil_1_lat, xend = facil_2_long, yend = facil_2_lat,     # draw edges as arcs
size = n_transfers/max(n_transfers)),
data = trans_geo, curvature = 0.33,
alpha = 0.2) +
geom_point(aes(size=n), alpha=0.5, color = "blue") +
theme_void() + theme(legend.position = "none")
facil_geo %>% ggplot(aes(x=long, y=lat)) +
geom_point(aes(size=n), alpha=0.5, color = "blue", fill = "blue") +
borders("state") +
coord_quickmap() +
geom_curve(aes(x = facil_1_long, y = facil_1_lat, xend = facil_2_long, yend = facil_2_lat,     # draw edges as arcs
size = n_transfers/max(n_transfers)),
data = trans_geo, curvature = 0.33,
alpha = 0.2) +
theme_void() + theme(legend.position = "none")
mat <- data.frame(matrix(data = c(0, 20, 30, 40,
20, 0, 26, 50,
30, 26, 0, 57,
40, 50, 57, 0), nrow = 4, ncol = 4))
rownames(mat) <- c("A", "B", "C", "D")
colnames(mat) <- c("A", "B", "C", "D")
mat
load_all()
devtools::load_all()
devtools::load_all()
is.null(check_long_form_input(mat))
mat
facil_dist <- mat
facil_dist
class(dists)
!(any(class(dists) == "matrix") || any(class(dists) == "data.frame"))
ncol(facil_dist)
nrow(facil_dist)
ncol(facil_dist) != nrow(facil_dist)
all(rownames(facil_dist)
== colnames(facil_dist))
devtools::load_all()
is.null(check_long_form_input(mat))
check_long_form_input("mat")
class("mat")
facil_dist <- "mat"
class(dists)
any(class(dists) == "matrix") || any(class(dists) == "data.frame")
class(dists) == "matrix")
class(dists) == "matrix" || any(class(dists) == "data.frame"
class(dists) == "matrix" || anyclass(dists) == "data.frame"
class(dists) == "matrix"
any(class(dists) == "matrix")
class(dists)
load_all()
devtools::load_all()
check_long_form_input("mat")
mat2 <- data.frame(matrix(data = c(0, 20, 12,
20, 0, 26,
30, 26, 0), nrow = 3, ncol = 3))
rownames(mat2) <- c("A", "B", "C")
colnames(mat2) <- c("A", "B", "C")
mat2
check_long_form_input(mat2)
mat2
mat[-1,]
check_long_form_input(mat[-1,])
mat3 <- mat1
mat3 <- mat
mat3
rownames(mat3) <- c(1, 2, 3, 4)
mat3
heck_long_form_input(mat3)
check_long_form_input(mat3)
library(ape)
library(dplyr)
library(devtools)
library(ggtree)
library(pheatmap)
library(ggplot2)
library(phytools)
library(gridExtra)
#set theme
theme_set(theme_bw() + theme(strip.background = element_rect(fill="white",linetype='blank'), text=element_text(size=15)))
Fsp_long <- na.omit(data.frame(as.table(as.matrix(Fsp)))) %>% filter(Freq != 0) %>% `colnames<-`(c("facil_1", "facil_2", "Fsp_val")) %>% subset_pairs() %>% left_join(pt_trans)
Fsp <- regentrans::Fsp
pheatmap(Fsp)
Fsp
Fsp %>% long_form()
Fsp %>% long_form() %>% subset_pairs()
Fsp %>% long_form() %>% subset_pairs() %>% left_join(pt_trans)
pt_trans <- patient_transfer(pt_trans_net = pt_flow, snv_dists = snv_dists, thresh = 10)
devtools::load_all()
library(ape)
library(dplyr)
library(devtools)
library(ggtree)
library(pheatmap)
library(ggplot2)
library(phytools)
library(gridExtra)
#set theme
theme_set(theme_bw() + theme(strip.background = element_rect(fill="white",linetype='blank'), text=element_text(size=15)))
locs <- metadata$locations
#named list of locations
locs <- regentrans::locs
#named list of patient IDs
pt <- regentrans::pt
#named list of isolate collection dates
dates <- regentrans::dates
#named list of sequence types
st <- NULL
#fasta file
fasta <- regentrans::fasta
#SNV distance matrix
dists <- regentrans::dists
#phylogenetic tree
tree <- regentrans::tr
#patient transfer network
pt_flow <- regentrans::pt_flow
snv_dists <- get_snv_dists(dists = dists, locs = locs, pt = pt)
snv_dists_sub <- subset_pairs(snv_dists)
ggplot() +
geom_histogram(data = subset(snv_dists_sub,Pair_Type == "Inter-facility pair"), mapping = aes(x = Pairwise_Dists, fill = "Inter-facility pair"), alpha = 0.2) +
geom_histogram(data = subset(snv_dists_sub,Pair_Type == "Intra-facility pair"), mapping = aes(x = Pairwise_Dists, fill = "Intra-facility pair"), alpha = 0.4) + labs(x = "Pairwise SNV Distance", y = "Count", fill = "Legend") +  ggtitle("SNV distances of intra- and inter- facility pairs")
frac_intra <- get_frac_intra(snv_dists = snv_dists) #or get_frac_intra(dists = dists, locs = locs, pt = pt)
ggplot(data = frac_intra, aes(x = Thresh, y = Frac_Intra)) + geom_bar(stat = "identity", fill = "blue", alpha = 0.5) + labs(x = "SNV Distance Threshold", y = "Fraction of Intra-Facility Pairs") +  ggtitle("Fraction of Isolate Pairs from the Same \nFacility at Each SNV Distance Threshold") + ylim(0, 1)
pt_trans <- patient_transfer(pt_trans_net = pt_flow, snv_dists = snv_dists, thresh = 10)
ggplot(data = pt_trans, mapping = aes(x = n_transfers, y = n_closely_related_pairs)) + geom_jitter(position = position_jitter(width = 0.2, height = 0.1), alpha = 0.2, color = "blue") + labs(y = "Number of Closely Related Isolate Pairs", x = "Number of Transfers", title = "Number of Patient Transfers from Facility \nvs. Number of Closely Related Isolate Pairs at Facility") + geom_smooth(method = "lm")
Fsp %>% long_form() %>% subset_pairs() %>% left_join(pt_trans, by = c()) %>% ggplot(mapping = aes(x = n_transfers, y = Fsp_val)) + geom_jitter(position = position_jitter(width = 0.2, height = 0.1), alpha = 0.2, color = "blue") + labs(y = "Fsp (population-level similarity)", x = "Number of Transfers", title = "Number of Patient Transfers from Facility \nvs. Fsp (population-level similarity)") + geom_smooth(method = "lm")
pt_trans
Fsp %>% long_form() %>% subset_pairs() %>% left_join(pt_trans, by = c("Facil_1" = "facil_1", "Facil_2" = "facil_2"))
Fsp %>% long_form() %>% subset_pairs() %>% left_join(pt_trans, by = c("Facil_1" = "facil_1", "Facil_2" = "facil_2")) %>% ggplot(mapping = aes(x = n_transfers, y = Fsp_val)) + geom_jitter(position = position_jitter(width = 0.2, height = 0.1), alpha = 0.2, color = "blue") + labs(y = "Fsp (population-level similarity)", x = "Number of Transfers", title = "Number of Patient Transfers from Facility \nvs. Fsp (population-level similarity)") + geom_smooth(method = "lm")
cities <- force(us.cities) %>% filter(!country.etc %in% c("HI", "AK"))
facilities <- unique(locs)
cities_sub <- cities[1:length(facilities),4:5]
facil_coord <- as.data.frame(cbind(facilities, cities_sub))
head(facil_coord)
loc_n <- locs %>% table() %>% as.data.frame() %>% `colnames<-`(c("facilities", "n"))
facil_geo <- facil_coord %>% left_join(loc_n)
Fsp_geo <- Fsp_long %>% left_join(facil_geo, by = c("facil_1" = "facilities")) %>% rename(facil_1_lat = lat, facil_1_long = long, facil_1_n = n) %>% left_join(facil_geo, by = c("facil_2" = "facilities")) %>% rename(facil_2_lat = lat, facil_2_long = long, facil_2_n = n)
loc_n <- locs %>% table() %>% as.data.frame() %>% `colnames<-`(c("facilities", "n"))
facil_geo <- facil_coord %>% left_join(loc_n)
Fsp_geo <- Fsp_long %>% left_join(facil_geo, by = c("Facil_1" = "facilities")) %>% rename(facil_1_lat = lat, facil_1_long = long, facil_1_n = n) %>% left_join(facil_geo, by = c("Facil_2" = "facilities")) %>% rename(facil_2_lat = lat, facil_2_long = long, facil_2_n = n)
loc_n <- locs %>% table() %>% as.data.frame() %>% `colnames<-`(c("facilities", "n"))
facil_geo <- facil_coord %>% left_join(loc_n)
Fsp_geo <- Fsp %>% long_form() %>% subset_pairs() %>% left_join(pt_trans, by = c("Facil_1" = "facil_1", "Facil_2" = "facil_2")) %>% left_join(facil_geo, by = c("Facil_1" = "facilities")) %>% rename(facil_1_lat = lat, facil_1_long = long, facil_1_n = n) %>% left_join(facil_geo, by = c("Facil_2" = "facilities")) %>% rename(facil_2_lat = lat, facil_2_long = long, facil_2_n = n)
facil_geo %>% ggplot(aes(x=long, y=lat)) +
geom_point(aes(size=n), alpha=0.5, color = "blue") +
borders("state") +
coord_quickmap() +
geom_curve(aes(x = facil_1_long, y = facil_1_lat, xend = facil_2_long, yend = facil_2_lat,
size = Fsp_val),
data = Fsp_geo, curvature = 0.33,
alpha = 0.2) +
theme_void() + theme(legend.position = "none")
trans_geo <- pt_trans %>% left_join(facil_geo, by = c("Facil_1" = "facilities")) %>% rename(facil_1_lat = lat, facil_1_long = long, facil_1_n = n) %>% left_join(facil_geo, by = c("Facil_2" = "facilities")) %>% rename(facil_2_lat = lat, facil_2_long = long, facil_2_n = n)
trans_geo <- pt_trans %>% left_join(facil_geo, by = c("facil_1" = "facilities")) %>% rename(facil_1_lat = lat, facil_1_long = long, facil_1_n = n) %>% left_join(facil_geo, by = c("facil_2" = "facilities")) %>% rename(facil_2_lat = lat, facil_2_long = long, facil_2_n = n)
facil_geo %>% ggplot(aes(x=long, y=lat)) +
geom_point(aes(size=n), alpha=0.5, color = "blue") +
borders("state") +
coord_quickmap() +
geom_curve(aes(x = facil_1_long, y = facil_1_lat, xend = facil_2_long, yend = facil_2_lat,
size = n_transfers/max(n_transfers)),
data = trans_geo, curvature = 0.33,
alpha = 0.2) +
theme_void() + theme(legend.position = "none")
load_all()
load_all()
load_all()
snv_dists
class(dists)
load_all()
test_dists <- dists[names(test_locs), names(test_locs)]
test_locs <- locs[1:4]
test_locs_2 <- locs[5:8]
test_locs_3 <- locs[1:3]
test_locs_4 <- locs[1]
test_locs_5 <- locs[locs %in% c("A", "F", "H")]
test_locs_6 <- locs[1:4]
test_locs_7 <- test_locs_5[1:4]
test_locs_8 <- test_locs_5[2:6]
test_locs_9 <- test_locs_5[1:6]
test_locs_fsp <- test_locs
test_locs_fsp[1:4] <- "A"
test_pt <- pt[1:4]
test_pt_2 <- pt[5:8]
test_pt_3 <- pt[1:3]
test_dists <- dists[names(test_locs), names(test_locs)]
check_subset_pairs_input(test_dists)
is.null(check_subset_pairs_input(test_dists))
check_subset_pairs_input("test_dists")
is.null(check_subset_pairs_input(test_dists))
check_subset_pairs_input("test_dists")
load_all()
is.null(check_subset_pairs_input(test_dists))
check_subset_pairs_input("test_dists")
document()
fasta <- regentrans::fasta
devtools::test()
devtools::test()
devtools::test()
devtools::test()
Fsp <- get_facility_fsp(fasta, locs)
load_all()
document()
Fsp <- get_facility_fsp(fasta = regentrans::fasta, locs = regentrans::locs)
View(Fsp)
save(Fsp, file="/Users/sophiehoffman/Desktop/regentrans/data/Fsp.RData")
pt_trans
library(ape)
library(dplyr)
library(devtools)
library(ggtree)
library(pheatmap)
library(ggplot2)
library(phytools)
library(gridExtra)
#set theme
theme_set(theme_bw() + theme(strip.background = element_rect(fill="white",linetype='blank'), text=element_text(size=15)))
devtools::load_all()
#named list of locations
locs <- regentrans::locs
#named list of patient IDs
pt <- regentrans::pt
#named list of isolate collection dates
dates <- regentrans::dates
#named list of sequence types
st <- NULL
#fasta file
fasta <- regentrans::fasta
#SNV distance matrix
dists <- regentrans::dists
#phylogenetic tree
tree <- regentrans::tr
#patient transfer network
pt_flow <- regentrans::pt_flow
snv_dists <- get_snv_dists(dists = dists, locs = locs, pt = pt)
permut <- setNames(as.data.frame(cbind(rep(unique(locs), each = 2), c("Inter-facility pair", "Intra-facility pair"))), c("Loc1_mut", "Pair_Type"))
for(i in 1:100){
#for reproducibility
set.seed(i)
summary  <- snv_dists %>% mutate(Loc1_mut = sample(Loc1)) %>% filter(Pairwise_Dists <= cutoff) %>% group_by(Loc1_mut, Pair_Type) %>% summarize(n = n())
permut <- left_join(permut, summary, by = c("Loc1_mut" = "Loc1_mut", "Pair_Type" = "Pair_Type"))
}
cutoff <- 10 #adjust according to your own analysis!
snv_dists %>% filter(Pairwise_Dists <= cutoff) %>% group_by(Loc1, Pair_Type) %>% summarize(n = n()) %>% ggplot(aes(x = Loc1, y = n, fill = Pair_Type)) + geom_bar(position = "dodge", stat = "identity") + labs(y = "Number of Closely Related Isolate Pairs", x = "Facility ID", title = "Number of Closely Related Isolate Pairs \nby Facility")
permut <- setNames(as.data.frame(cbind(rep(unique(locs), each = 2), c("Inter-facility pair", "Intra-facility pair"))), c("Loc1_mut", "Pair_Type"))
for(i in 1:100){
#for reproducibility
set.seed(i)
summary  <- snv_dists %>% mutate(Loc1_mut = sample(Loc1)) %>% filter(Pairwise_Dists <= cutoff) %>% group_by(Loc1_mut, Pair_Type) %>% summarize(n = n())
permut <- left_join(permut, summary, by = c("Loc1_mut" = "Loc1_mut", "Pair_Type" = "Pair_Type"))
}
permut %>% `colnames<-`(c("Loc1", "Pair_Type", 1:100)) %>% tidyr::pivot_longer(!c(Loc1, Pair_Type), names_to = "run", values_to = "value") %>% ggplot() + geom_boxplot(mapping = aes(x = Loc1, y = value, fill = Pair_Type)) + geom_point(data = (snv_dists %>% filter(Pairwise_Dists <= cutoff) %>% group_by(Loc1, Pair_Type) %>% summarize(n = n())), mapping = aes(x = Loc1, y = n, color = Pair_Type), shape = 23) + scale_color_manual(values=c("red", "blue")) + labs(y = "Number of Closely Related \nIsolate Pairs (permuted)", x = "Facility ID", title = "Permuted Number of Closely Related Isolate Pairs \nby Facility with real-value points")
permut <- setNames(as.data.frame(cbind(rep(unique(locs), each = 2), c("Inter-facility pair", "Intra-facility pair"))), c("Loc1_mut", "Pair_Type"))
for(i in 1:100){
#for reproducibility
set.seed(i)
summary  <- snv_dists %>% mutate(Loc1_mut = sample(Loc1)) %>% filter(Pairwise_Dists <= cutoff) %>% group_by(Loc1_mut, Pair_Type) %>% summarize(n = n())
permut <- left_join(permut, summary, by = c("Loc1_mut" = "Loc1_mut", "Pair_Type" = "Pair_Type"))
}
permut %>% `colnames<-`(c("Loc1", "Pair_Type", 1:100)) %>% tidyr::pivot_longer(!c(Loc1, Pair_Type), names_to = "run", values_to = "value") %>% ggplot() + geom_boxplot(mapping = aes(x = Loc1, y = value, fill = Pair_Type)) + geom_point(data = (snv_dists %>% filter(Pairwise_Dists <= cutoff) %>% group_by(Loc1, Pair_Type) %>% summarize(n = n())), mapping = aes(x = Loc1, y = n, color = Pair_Type), shape = 17) + scale_color_manual(values=c("red", "blue")) + labs(y = "Number of Closely Related \nIsolate Pairs (permuted)", x = "Facility ID", title = "Permuted Number of Closely Related Isolate Pairs \nby Facility with real-value points")
permut %>% `colnames<-`(c("Loc1", "Pair_Type", 1:100)) %>% tidyr::pivot_longer(!c(Loc1, Pair_Type), names_to = "run", values_to = "value") %>% ggplot() + geom_boxplot(mapping = aes(x = Loc1, y = value, fill = Pair_Type)) + geom_point(data = (snv_dists %>% filter(Pairwise_Dists <= cutoff) %>% group_by(Loc1, Pair_Type) %>% summarize(n = n())), mapping = aes(x = Loc1, y = n, color = Pair_Type), shape = 15) + scale_color_manual(values=c("red", "blue")) + labs(y = "Number of Closely Related \nIsolate Pairs (permuted)", x = "Facility ID", title = "Permuted Number of Closely Related Isolate Pairs \nby Facility with real-value points")
devtools::test()
